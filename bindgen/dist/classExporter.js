"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClassExporter = void 0;
const as_1 = require("visitor-as/as");
const visitor_as_1 = require("visitor-as");
const JSONBuilder_1 = require("./JSONBuilder");
const utils_1 = require("./utils");
const toString = visitor_as_1.utils.toString;
class ClassExporter extends visitor_as_1.ClassDecorator {
    constructor() {
        super(...arguments);
        this.sb = [];
    }
    static get className() {
        return toString(ClassExporter.classSeen.name);
    }
    checkMethods(name) {
        let _class = ClassExporter.classSeen;
        _class.members.forEach((member) => {
            if (member instanceof as_1.MethodDeclaration &&
                !member.is(as_1.CommonFlags.PRIVATE)) {
                if (toString(member.name) === name) {
                    throw new Error(`Method "${toString(member.name)}" already used; cannot export constructor using the same name.`);
                }
            }
        });
    }
    visitFieldDeclaration(node) { }
    visitMethodDeclaration(node) {
        if (node.is(as_1.CommonFlags.SET) || node.is(as_1.CommonFlags.GET)) {
            throw new Error("Exported Singleton class cannot have properties. Found " +
                node.name.text);
        }
        // Private methods should be skipped.
        if (node.is(as_1.CommonFlags.PRIVATE)) {
            return;
        }
        let name = toString(node.name);
        let decorators = (node.decorators || []).map(toString);
        let returnType = toString(node.signature.returnType);
        let origParams = node.signature.parameters.map(visitor_as_1.utils.cloneNode);
        let parameters = origParams.map((param) => {
            if (param.implicitFieldDeclaration) {
                param.name.text = param.name.text.substring(2);
            }
            return toString(param);
        });
        let pramNames = origParams.map((param) => {
            return toString(param.name);
        });
        let isInit = name === "constructor";
        let assertStr = "";
        if (isInit) {
            assertStr = `assert(isNull(__contract), "contract is already initialized");`;
        }
        else if (ClassExporter.hasConstructor) {
            assertStr = `assert(!isNull(__contract), "contract is not initialized");`;
        }
        let isVoid = returnType === "void";
        let body = isInit
            ? `__contract = new ${ClassExporter.className}(${pramNames.join(", ")});`
            : `${!isVoid ? "let res =  " : ""}__contract.${name}(${pramNames.join(", ")});`;
        if (isInit) {
            name = "init";
            parameters = origParams.map((node) => `${toString(node.name)}: ${toString(node.type)}${node.initializer ? " = " + toString(node.initializer) : ""}`);
            returnType = "void";
        }
        if (isInit) {
            if (!decorators.some((decorator) => decorator.includes("exportAs"))) {
                decorators.push(`@exportAs("new")`);
                this.checkMethods("new");
            }
            else {
                let decorator = node.decorators.find((d) => toString(d.name) === "exportAs");
                if (decorator.args.length == 1) {
                    this.checkMethods(toString(decorator.args[0]));
                }
            }
        }
        const hasMutateState = decorators.some((decorator) => {
            let res = decorator.includes("mutateState");
            return res;
        });
        this.sb.push(`${decorators.join("\n")}
export function ${name}(${parameters.join(", ")}): ${returnType} {
  ${assertStr}
  ${body}
  ${isInit || hasMutateState ? `__setState(__contract);` : ""}
  ${isVoid || isInit ? "" : "return res;"}
}`);
    }
    visitClassDeclaration(node) {
        if (JSONBuilder_1.isEntry(node) && node.is(as_1.CommonFlags.EXPORT)) {
            let name = toString(node.name);
            if (ClassExporter.classSeen) {
                throw new Error(`Cannot export class ${name}. ${ClassExporter.className} already exported. `);
            }
            ClassExporter.classSeen = node;
            ClassExporter.hasConstructor = node.members.some((member) => {
                if (member instanceof as_1.MethodDeclaration) {
                    return toString(member.name) === "constructor";
                }
                return false;
            });
            this.sb.push(`let __contract: ${name};
if (__checkState()) {
  __contract = __getState<${name}>();
}${!ClassExporter.hasConstructor
                ? ` else {
  __contract = new ${name}();
}`
                : ""}`);
            this.visit(node.members);
            node.flags = node.flags ^ as_1.CommonFlags.EXPORT;
            let newStatements = utils_1.SimpleParser.parseTopLevel(this.sb.join("\n")).map((n) => {
                if (n instanceof as_1.FunctionDeclaration) {
                    n.flags = n.flags | as_1.CommonFlags.EXPORT;
                    n.flags = n.flags | as_1.CommonFlags.MODULE_EXPORT;
                }
                n.range = node.range;
                return n;
            });
            node.range.source.statements.push(...newStatements);
        }
    }
    get name() {
        return "nearBindgen";
    }
    static visit(source) {
        if (source.sourceKind != as_1.SourceKind.USER_ENTRY) {
            return;
        }
        let visitor = new ClassExporter();
        visitor.visit(source);
    }
}
exports.ClassExporter = ClassExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xhc3NFeHBvcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGFzc0V4cG9ydGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNDQVF1QjtBQUN2QiwyQ0FBbUQ7QUFDbkQsK0NBQXdDO0FBQ3hDLG1DQUF1QztBQUV2QyxNQUFNLFFBQVEsR0FBRyxrQkFBSyxDQUFDLFFBQVEsQ0FBQztBQUVoQyxNQUFhLGFBQWMsU0FBUSwyQkFBYztJQUFqRDs7UUFDRSxPQUFFLEdBQWEsRUFBRSxDQUFDO0lBNkpwQixDQUFDO0lBekpDLE1BQU0sS0FBSyxTQUFTO1FBQ2xCLE9BQU8sUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUFZO1FBQ3ZCLElBQUksTUFBTSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUM7UUFDckMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUNoQyxJQUNFLE1BQU0sWUFBWSxzQkFBaUI7Z0JBQ25DLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxnQkFBVyxDQUFDLE9BQU8sQ0FBQyxFQUMvQjtnQkFDQSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO29CQUNsQyxNQUFNLElBQUksS0FBSyxDQUNiLFdBQVcsUUFBUSxDQUNqQixNQUFNLENBQUMsSUFBSSxDQUNaLGdFQUFnRSxDQUNsRSxDQUFDO2lCQUNIO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxJQUFzQixJQUFTLENBQUM7SUFFdEQsc0JBQXNCLENBQUMsSUFBdUI7UUFDNUMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDLGdCQUFXLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxnQkFBVyxDQUFDLEdB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dkMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLGdCQUFXLENBQUMsYUFBYSxDQUFDO2lCQUMvQztnQkFDRCxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7Z0JBQ3JCLE9BQU8sQ0FBQyxDQUFDO1lBQ1gsQ0FBQyxDQUNGLENBQUM7WUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBYSxDQUFDLENBQUM7U0FDckQ7SUFDSCxDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ04sT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBYztRQUN6QixJQUFJLE1BQU0sQ0FBQyxVQUFVLElBQUksZUFBVSxDQUFDLFVBQVUsRUFBRTtZQUM5QyxPQUFPO1NBQ1I7UUFDRCxJQUFJLE9BQU8sR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQ2xDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEIsQ0FBQztDQUNGO0FBOUpELHNDQThKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ2xhc3NEZWNsYXJhdGlvbixcclxuICBGaWVsZERlY2xhcmF0aW9uLFxyXG4gIE1ldGhvZERlY2xhcmF0aW9uLFxyXG4gIFNvdXJjZSxcclxuICBDb21tb25GbGFncyxcclxuICBTb3VyY2VLaW5kLFxyXG4gIEZ1bmN0aW9uRGVjbGFyYXRpb24sXHJcbn0gZnJvbSBcInZpc2l0b3ItYXMvYXNcIjtcclxuaW1wb3J0IHsgdXRpbHMsIENsYXNzRGVjb3JhdG9yIH0gZnJvbSBcInZpc2l0b3ItYXNcIjtcclxuaW1wb3J0IHsgaXNFbnRyeSB9IGZyb20gXCIuL0pTT05CdWlsZGVyXCI7XHJcbmltcG9ydCB7IFNpbXBsZVBhcnNlciB9IGZyb20gXCIuL3V0aWxzXCI7XHJcblxyXG5jb25zdCB0b1N0cmluZyA9IHV0aWxzLnRvU3RyaW5nO1xyXG5cclxuZXhwb3J0IGNsYXNzIENsYXNzRXhwb3J0ZXIgZXh0ZW5kcyBDbGFzc0RlY29yYXRvciB7XHJcbiAgc2I6IHN0cmluZ1tdID0gW107XHJcbiAgc3RhdGljIGNsYXNzU2VlbjogQ2xhc3NEZWNsYXJhdGlvbjtcclxuICBzdGF0aWMgaGFzQ29uc3RydWN0b3I6IGJvb2xlYW47XHJcblxyXG4gIHN0YXRpYyBnZXQgY2xhc3NOYW1lKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdG9TdHJpbmcoQ2xhc3NFeHBvcnRlci5jbGFzc1NlZW4ubmFtZSk7XHJcbiAgfVxyXG5cclxuICBjaGVja01ldGhvZHMobmFtZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgX2NsYXNzID0gQ2xhc3NFeHBvcnRlci5jbGFzc1NlZW47XHJcbiAgICBfY2xhc3MubWVtYmVycy5mb3JFYWNoKChtZW1iZXIpID0+IHtcclxuICAgICAgaWYgKFxyXG4gICAgICAgIG1lbWJlciBpbnN0YW5jZW9mIE1ldGhvZERlY2xhcmF0aW9uICYmXHJcbiAgICAgICAgIW1lbWJlci5pcyhDb21tb25GbGFncy5QUklWQVRFKVxyXG4gICAgICApIHtcclxuICAgICAgICBpZiAodG9TdHJpbmcobWVtYmVyLm5hbWUpID09PSBuYW1lKSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgIGBNZXRob2QgXCIke3RvU3RyaW5nKFxyXG4gICAgICAgICAgICAgIG1lbWJlci5uYW1lXHJcbiAgICAgICAgICAgICl9XCIgYWxyZWFkeSB1c2VkOyBjYW5ub3QgZXhwb3J0IGNvbnN0cnVjdG9yIHVzaW5nIHRoZSBzYW1lIG5hbWUuYFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgdmlzaXRGaWVsZERlY2xhcmF0aW9uKG5vZGU6IEZpZWxkRGVjbGFyYXRpb24pOiB2b2lkIHt9XHJcblxyXG4gIHZpc2l0TWV0aG9kRGVjbGFyYXRpb24obm9kZTogTWV0aG9kRGVjbGFyYXRpb24pOiB2b2lkIHtcclxuICAgIGlmIChub2RlLmlzKENvbW1vbkZsYWdzLlNFVCkgfHwgbm9kZS5pcyhDb21tb25GbGFncy5HRVQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICBcIkV4cG9ydGVkIFNpbmdsZXRvbiBjbGFzcyBjYW5ub3QgaGF2ZSBwcm9wZXJ0aWVzLiBGb3VuZCBcIiArXHJcbiAgICAgICAgICBub2RlLm5hbWUudGV4dFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgLy8gUHJpdmF0ZSBtZXRob2RzIHNob3VsZCBiZSBza2lwcGVkLlxyXG4gICAgaWYgKG5vZGUuaXMoQ29tbW9uRmxhZ3MuUFJJVkFURSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IG5hbWUgPSB0b1N0cmluZyhub2RlLm5hbWUpO1xyXG4gICAgbGV0IGRlY29yYXRvcnMgPSAobm9kZS5kZWNvcmF0b3JzIHx8IFtdKS5tYXAodG9TdHJpbmcpO1xyXG4gICAgbGV0IHJldHVyblR5cGUgPSB0b1N0cmluZyhub2RlLnNpZ25hdHVyZS5yZXR1cm5UeXBlKTtcclxuICAgIGxldCBvcmlnUGFyYW1zID0gbm9kZS5zaWduYXR1cmUucGFyYW1ldGVycy5tYXAodXRpbHMuY2xvbmVOb2RlKTtcclxuICAgIGxldCBwYXJhbWV0ZXJzID0gb3JpZ1BhcmFtcy5tYXAoKHBhcmFtKSA9PiB7XHJcbiAgICAgIGlmIChwYXJhbS5pbXBsaWNpdEZpZWxkRGVjbGFyYXRpb24pIHtcclxuICAgICAgICBwYXJhbS5uYW1lLnRleHQgPSBwYXJhbS5uYW1lLnRleHQuc3Vic3RyaW5nKDIpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0b1N0cmluZyhwYXJhbSk7XHJcbiAgICB9KTtcclxuICAgIGxldCBwcmFtTmFtZXMgPSBvcmlnUGFyYW1zLm1hcCgocGFyYW0pID0+IHtcclxuICAgICAgcmV0dXJuIHRvU3RyaW5nKHBhcmFtLm5hbWUpO1xyXG4gICAgfSk7XHJcbiAgICBsZXQgaXNJbml0ID0gbmFtZSA9PT0gXCJjb25zdHJ1Y3RvclwiO1xyXG4gICAgbGV0IGFzc2VydFN0cjogc3RyaW5nID0gXCJcIjtcclxuICAgIGlmIChpc0luaXQpIHtcclxuICAgICAgYXNzZXJ0U3RyID0gYGFzc2VydChpc051bGwoX19jb250cmFjdCksIFwiY29udHJhY3QgaXMgYWxyZWFkeSBpbml0aWFsaXplZFwiKTtgO1xyXG4gICAgfSBlbHNlIGlmIChDbGFzc0V4cG9ydGVyLmhhc0NvbnN0cnVjdG9yKSB7XHJcbiAgICAgIGFzc2VydFN0ciA9IGBhc3NlcnQoIWlzTnVsbChfX2NvbnRyYWN0KSwgXCJjb250cmFjdCBpcyBub3QgaW5pdGlhbGl6ZWRcIik7YDtcclxuICAgIH1cclxuICAgIGxldCBpc1ZvaWQgPSByZXR1cm5UeXBlID09PSBcInZvaWRcIjtcclxuICAgIGxldCBib2R5ID0gaXNJbml0XHJcbiAgICAgID8gYF9fY29udHJhY3QgPSBuZXcgJHtDbGFzc0V4cG9ydGVyLmNsYXNzTmFtZX0oJHtwcmFtTmFtZXMuam9pbihcIiwgXCIpfSk7YFxyXG4gICAgICA6IGAkeyFpc1ZvaWQgPyBcImxldCByZXMgPSAgXCIgOiBcIlwifV9fY29udHJhY3QuJHtuYW1lfSgke3ByYW1OYW1lcy5qb2luKFxyXG4gICAgICAgICAgXCIsIFwiXHJcbiAgICAgICAgKX0pO2A7XHJcbiAgICBpZiAoaXNJbml0KSB7XHJcbiAgICAgIG5hbWUgPSBcImluaXRcIjtcclxuICAgICAgcGFyYW1ldGVycyA9IG9yaWdQYXJhbXMubWFwKFxyXG4gICAgICAgIChub2RlKSA9PlxyXG4gICAgICAgICAgYCR7dG9TdHJpbmcobm9kZS5uYW1lKX06ICR7dG9TdHJpbmcobm9kZS50eXBlKX0ke1xyXG4gICAgICAgICAgICBub2RlLmluaXRpYWxpemVyID8gXCIgPSBcIiArIHRvU3RyaW5nKG5vZGUuaW5pdGlhbGl6ZXIpIDogXCJcIlxyXG4gICAgICAgICAgfWBcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuVHlwZSA9IFwidm9pZFwiO1xyXG4gICAgfVxyXG4gICAgaWYgKGlzSW5pdCkge1xyXG4gICAgICBpZiAoIWRlY29yYXRvcnMuc29tZSgoZGVjb3JhdG9yKSA9PiBkZWNvcmF0b3IuaW5jbHVkZXMoXCJleHBvcnRBc1wiKSkpIHtcclxuICAgICAgICBkZWNvcmF0b3JzLnB1c2goYEBleHBvcnRBcyhcIm5ld1wiKWApO1xyXG4gICAgICAgIHRoaXMuY2hlY2tNZXRob2RzKFwibmV3XCIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCBkZWNvcmF0b3IgPSBub2RlLmRlY29yYXRvcnMhLmZpbmQoXHJcbiAgICAgICAgICAoZCkgPT4gdG9TdHJpbmcoZC5uYW1lKSA9PT0gXCJleHBvcnRBc1wiXHJcbiAgICAgICAgKSE7XHJcbiAgICAgICAgaWYgKGRlY29yYXRvci5hcmdzIS5sZW5ndGggPT0gMSkge1xyXG4gICAgICAgICAgdGhpcy5jaGVja01ldGhvZHModG9TdHJpbmcoZGVjb3JhdG9yLmFyZ3MhWzBdKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCBoYXNNdXRhdGVTdGF0ZSA9IGRlY29yYXRvcnMuc29tZSgoZGVjb3JhdG9yKSA9PiB7XHJcbiAgICAgIGxldCByZXMgPSBkZWNvcmF0b3IuaW5jbHVkZXMoXCJtdXRhdGVTdGF0ZVwiKTtcclxuICAgICAgcmV0dXJuIHJlcztcclxuICAgIH0pO1xyXG4gICAgdGhpcy5zYi5wdXNoKFxyXG4gICAgICBgJHtkZWNvcmF0b3JzLmpvaW4oXCJcXG5cIil9XHJcbmV4cG9ydCBmdW5jdGlvbiAke25hbWV9KCR7cGFyYW1ldGVycy5qb2luKFwiLCBcIil9KTogJHtyZXR1cm5UeXBlfSB7XHJcbiAgJHthc3NlcnRTdHJ9XHJcbiAgJHtib2R5fVxyXG4gICR7aXNJbml0IHx8IGhhc011dGF0ZVN0YXRlID8gYF9fc2V0U3RhdGUoX19jb250cmFjdCk7YCA6IFwiXCJ9XHJcbiAgJHtpc1ZvaWQgfHwgaXNJbml0ID8gXCJcIiA6IFwicmV0dXJuIHJlcztcIn1cclxufWBcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICB2aXNpdENsYXNzRGVjbGFyYXRpb24obm9kZTogQ2xhc3NEZWNsYXJhdGlvbik6IHZvaWQge1xyXG4gICAgaWYgKGlzRW50cnkobm9kZSkgJiYgbm9kZS5pcyhDb21tb25GbGFncy5FWFBPUlQpKSB7XHJcbiAgICAgIGxldCBuYW1lID0gdG9TdHJpbmcobm9kZS5uYW1lKTtcclxuICAgICAgaWYgKENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgYENhbm5vdCBleHBvcnQgY2xhc3MgJHtuYW1lfS4gJHtDbGFzc0V4cG9ydGVyLmNsYXNzTmFtZX0gYWxyZWFkeSBleHBvcnRlZC4gYFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICAgQ2xhc3NFeHBvcnRlci5jbGFzc1NlZW4gPSBub2RlO1xyXG4gICAgICBDbGFzc0V4cG9ydGVyLmhhc0NvbnN0cnVjdG9yID0gbm9kZS5tZW1iZXJzLnNvbWUoKG1lbWJlcikgPT4ge1xyXG4gICAgICAgIGlmIChtZW1iZXIgaW5zdGFuY2VvZiBNZXRob2REZWNsYXJhdGlvbikge1xyXG4gICAgICAgICAgcmV0dXJuIHRvU3RyaW5nKG1lbWJlci5uYW1lKSA9PT0gXCJjb25zdHJ1Y3RvclwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLnNiLnB1c2goXHJcbiAgICAgICAgYGxldCBfX2NvbnRyYWN0OiAke25hbWV9O1xyXG5pZiAoX19jaGVja1N0YXRlKCkpIHtcclxuICBfX2NvbnRyYWN0ID0gX19nZXRTdGF0ZTwke25hbWV9PigpO1xyXG59JHtcclxuICAgICAgICAgICFDbGFzc0V4cG9ydGVyLmhhc0NvbnN0cnVjdG9yXHJcbiAgICAgICAgICAgID8gYCBlbHNlIHtcclxuICBfX2NvbnRyYWN0ID0gbmV3ICR7bmFtZX0oKTtcclxufWBcclxuICAgICAgICAgICAgOiBcIlwiXHJcbiAgICAgICAgfWBcclxuICAgICAgKTtcclxuICAgICAgdGhpcy52aXNpdChub2RlLm1lbWJlcnMpO1xyXG4gICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyBeIENvbW1vbkZsYWdzLkVYUE9SVDtcclxuICAgICAgbGV0IG5ld1N0YXRlbWVudHMgPSBTaW1wbGVQYXJzZXIucGFyc2VUb3BMZXZlbCh0aGlzLnNiLmpvaW4oXCJcXG5cIikpLm1hcChcclxuICAgICAgICAobikgPT4ge1xyXG4gICAgICAgICAgaWYgKG4gaW5zdGFuY2VvZiBGdW5jdGlvbkRlY2xhcmF0aW9uKSB7XHJcbiAgICAgICAgICAgIG4uZmxhZ3MgPSBuLmZsYWdzIHwgQ29tbW9uRmxhZ3MuRVhQT1JUO1xyXG4gICAgICAgICAgICBuLmZsYWdzID0gbi5mbGFncyB8IENvbW1vbkZsYWdzLk1PRFVMRV9FWFBPUlQ7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBuLnJhbmdlID0gbm9kZS5yYW5nZTtcclxuICAgICAgICAgIHJldHVybiBuO1xyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgICAgbm9kZS5yYW5nZS5zb3VyY2Uuc3RhdGVtZW50cy5wdXNoKC4uLm5ld1N0YXRlbWVudHMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0IG5hbWUoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBcIm5lYXJCaW5kZ2VuXCI7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgdmlzaXQoc291cmNlOiBTb3VyY2UpOiB2b2lkIHtcclxuICAgIGlmIChzb3VyY2Uuc291cmNlS2luZCAhPSBTb3VyY2VLaW5kLlVTRVJfRU5UUlkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IHZpc2l0b3IgPSBuZXcgQ2xhc3NFeHBvcnRlcigpO1xyXG4gICAgdmlzaXRvci52aXNpdChzb3VyY2UpO1xyXG4gIH1cclxufVxyXG4iXX0=